@using Application.DTOs.MovieDTOs
@using Microsoft.AspNetCore.Mvc.Rendering
@using MVC.Constants
@model MovieDto

@{
    var cover = !string.IsNullOrWhiteSpace(Model.CoverImageUrl)
        ? Model.CoverImageUrl
        : $"https://picsum.photos/800/450?random={Model.Id}";

    var token = Context.Session.GetString(SessionKeys.JwtToken);
    var memberId = Context.Session.GetInt32(SessionKeys.MemberId);
    var loggedIn = !string.IsNullOrWhiteSpace(token) && memberId.HasValue;

    var lists = ViewBag.MemberLists as List<SelectListItem> ?? new List<SelectListItem>();
    var hasLists = lists.Any();

    var returnUrl = $"{Context.Request.Path}{Context.Request.QueryString}";
}

<div class="fd-cardwrap">
    <div class="fd-card fd-card--full">
        @* Kartın her yeri tıklanınca Detay *@
        <a class="fd-cardlink fd-cardlink--overlay"
           asp-controller="Product"
           asp-action="Details"
           asp-route-id="@Model.Id"
           aria-label="@Model.Title detay">
        </a>

        <div class="fd-poster fd-poster--land">
            <div class="fd-chip">Detay</div>
            <div class="fd-play">▶</div>

            <img src="@cover" alt="@Model.Title" loading="lazy" />
        </div>

        <div class="fd-body">
            <div class="fd-title">@Model.Title</div>

            <div class="fd-meta">
                <span class="pill">@Model.ReleaseYear</span>

                @* MovieDto’nda CategoryNames varsa ilkini göster, yoksa CategoryName *@
                @if (Model.CategoryNames != null && Model.CategoryNames.Count > 0)
                {
                    <span class="pill">@Model.CategoryNames.First()</span>
                }
                else if (!string.IsNullOrWhiteSpace(Model.CategoryName))
                {
                    <span class="pill">@Model.CategoryName</span>
                }
            </div>

            @if (Model.CategoryNames != null && Model.CategoryNames.Count > 0)
            {
                <div class="fd-tags">
                    @foreach (var t in Model.CategoryNames.Take(3))
                    {
                        <span class="fd-tag">@t</span>
                    }
                </div>
            }

            <p class="fd-desc">
                @(string.IsNullOrWhiteSpace(Model.Description) ? "Açıklama bulunmuyor." : Model.Description)
            </p>
        </div>
    </div>

    @* Alt aksiyon bölümü: login/listeye ekleme *@
    @if (!loggedIn)
    {
        <div class="fd-login-hint">Listeye eklemek için giriş yap.</div>
    }
    else if (!hasLists)
    {
        <div class="fd-login-hint">Önce bir liste oluşturmalısın.</div>
    }
    else
    {
        <form asp-controller="Product" asp-action="AddToList" method="post" class="mt-2 fd-formzone">
            @Html.AntiForgeryToken()
            <input type="hidden" name="movieId" value="@Model.Id" />
            <input type="hidden" name="returnUrl" value="@returnUrl" />

            <div class="fd-actions">
                <select class="form-select fd-select" name="listId" required>
                    @foreach (var item in lists)
                    {
                        <option value="@item.Value">@item.Text</option>
                    }
                </select>

                <input class="form-control fd-input"
                       name="priority"
                       type="number"
                       min="1"
                       placeholder="Öncelik" />

                <button type="submit" class="btn btn-danger">Ekle</button>
            </div>
        </form>
    }
</div>
